<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>JUN HYEOK RPG (Mobile)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="theme-color" content="#222222" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <style>
    :root{--bg:#121212;--panel:#1e1e1e;--ink:#f5f5f5;--accent:#ffd54d;--muted:#9e9e9e;}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',system-ui}
    .wrap{max-width:560px;margin:0 auto;height:100%;display:flex;flex-direction:column}
    header{padding:14px 16px;background:#000;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}
    .brand{font-weight:700}
    .pill{padding:6px 10px;border-radius:999px;background:#2a2a2a;font-size:12px;color:var(--muted)}
    main{flex:1;overflow:auto}
    .panel{background:var(--panel);border:1px solid #2c2c2c;border-radius:16px;padding:14px;margin:12px}
    .btn{width:100%;padding:14px 16px;border:none;border-radius:12px;background:var(--accent);color:#000;font-weight:700;font-size:16px}
    .btn.secondary{background:#2a2a2a;color:var(--ink);border:1px solid #3a3a3a}
    .btn:active{transform:scale(.98)}
    .row{display:flex;gap:8px}
    .tabs{display:flex;gap:8px;padding:10px;position:sticky;bottom:0;background:#000}
    .tab{flex:1;padding:10px;border-radius:12px;background:#1a1a1a;color:#ddd;text-align:center;font-size:12px}
    .tab.active{background:var(--accent);color:#000;font-weight:800}
    h2{margin:6px 0 10px 0;font-size:18px}
    textarea,input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #3a3a3a;background:#151515;color:#fff;font-size:15px}
    .mono{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace}
    .muted{color:var(--muted)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">JUN HYEOK RPG</div>
      <div class="pill" id="topStats">LV1 â€¢ 0/10XP â€¢ 150G</div>
    </header>

    <main id="screen">

      <!-- ì‹œì‘ í™”ë©´ -->
      <section class="panel" id="start">
        <h2>ëª¨í—˜ì„ ì‹œì‘í•©ë‹ˆë‹¤</h2>
        <p class="muted">API í‚¤ê°€ ì—†ìœ¼ë©´ ëª¨ì˜í‰ê°€ë¡œ ì§„í–‰ë©ë‹ˆë‹¤. (ì„¤ì • íƒ­)</p>
        <button class="btn" id="btnStart">ê²Œì„ ì‹œì‘</button>
      </section>

      <!-- í€˜ìŠ¤íŠ¸ -->
      <section class="panel hidden" id="quests">
        <h2>ğŸ“œ í€˜ìŠ¤íŠ¸</h2>
        <div id="questList" class="mono"></div>
        <div id="questDetail" class="panel hidden">
          <div id="qMeta" class="mono"></div>
          <textarea id="qAnswer" rows="6" placeholder="ì—¬ê¸°ì— ì œì¶œë¬¼ì„ ì‘ì„± (í€´ì¦ˆí˜•ì€ A/B/C/D)"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn secondary" id="btnMock">ëª¨ì˜í‰ê°€</button>
            <button class="btn" id="btnEval">GPT í‰ê°€</button>
          </div>
          <div id="qResult" class="mono" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- ìƒíƒœ -->
      <section class="panel hidden" id="status">
        <h2>ğŸ“Š ìƒíƒœ</h2>
        <div id="statusBody" class="mono"></div>
      </section>

      <!-- ì¸ë²¤í† ë¦¬ -->
      <section class="panel hidden" id="inventory">
        <h2>ğŸ’ ì¸ë²¤í† ë¦¬</h2>
        <div id="invBody" class="mono">ì•„ì´í…œ ì—†ìŒ</div>
      </section>

      <!-- í¬íŠ¸í´ë¦¬ì˜¤ -->
      <section class="panel hidden" id="portfolio">
        <h2>ğŸ—‚ í¬íŠ¸í´ë¦¬ì˜¤</h2>
        <div id="pfBody" class="mono muted">ì•„ì§ ê¸°ë¡ ì—†ìŒ</div>
      </section>

      <!-- ì„¤ì • -->
      <section class="panel hidden" id="settings">
        <h2>âš™ï¸ ì„¤ì •</h2>
        <label class="muted">OpenAI API í‚¤ (ì„ íƒ)</label>
        <input id="apiKey" placeholder="sk-..." />
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnSaveKey">í‚¤ ì €ì¥</button>
          <button class="btn secondary" id="btnExport">ì„¸ì´ë¸Œ ë‚´ë³´ë‚´ê¸°</button>
          <button class="btn secondary" id="btnImport">ì„¸ì´ë¸Œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </section>

    </main>

    <nav class="tabs">
      <div class="tab active" data-tab="start">ì‹œì‘</div>
      <div class="tab" data-tab="quests">í€˜ìŠ¤íŠ¸</div>
      <div class="tab" data-tab="status">ìƒíƒœ</div>
      <div class="tab" data-tab="inventory">ê°€ë°©</div>
      <div class="tab" data-tab="portfolio">í¬í´</div>
      <div class="tab" data-tab="settings">ì„¤ì •</div>
    </nav>
  </div>

  <script>
    // ====== ê°„ë‹¨ ìƒíƒœ ======
    const SKEY='JH_MOBILE_SAVE_V1', AKEY='JH_OPENAI_KEY';
    const baseStats={ê°ê°:5,ê¸°íšë ¥:5,ìì•„ê°ì§€ë ¥:5,ì§‘ì¤‘ë ¥:5,ì •ë¦¬ë ¥:5,ì‚¬ê³ ìœ ì—°ì„±:5,ë¶„ì„ë ¥:5,ì²´ë ¥:5,ì†Œí†µëŠ¥ë ¥:5,ë°©í–¥ê°ê°:5};
    let S=JSON.parse(localStorage.getItem(SKEY)||'null')||{
      name:'JUN HYEOK', level:1, exp:0, gold:150, routineCoin:1,
      stats: {...baseStats}, titles:[], inv:[], portfolio:[],
      quests: makeQuests(120)
    };

    // ====== UI ì „í™˜ ======
    const tabs=[...document.querySelectorAll('.tab')];
    const views=['start','quests','status','inventory','portfolio','settings'];
    tabs.forEach(t=>t.onclick=()=>show(t.dataset.tab));
    function show(id){
      views.forEach(v=>document.getElementById(v).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===id));
      renderTop(); if(id==='quests') renderQuests();
      if(id==='status') renderStatus();
      if(id==='inventory') renderInv();
      if(id==='portfolio') renderPf();
      if(id==='settings') document.getElementById('apiKey').value=(localStorage.getItem(AKEY)||'');
    }

    // ====== ë Œë” ======
    function needExp(){return S.level*10}
    function renderTop(){ document.getElementById('topStats').textContent=`LV${S.level} â€¢ ${S.exp}/${needExp()}XP â€¢ ${S.gold}G` }
    function renderStatus(){
      const l=[`ì´ë¦„: ${S.name}`,`ë ˆë²¨: ${S.level}  EXP: ${S.exp}/${needExp()}  GOLD: ${S.gold}`, '', '[ëŠ¥ë ¥ì¹˜]'];
      Object.entries(S.stats).forEach(([k,v])=>l.push(`- ${k}: ${v}`));
      document.getElementById('statusBody').textContent=l.join('\n');
    }
    function renderInv(){ document.getElementById('invBody').textContent=S.inv.length? S.inv.map((it,i)=>`${i+1}. ${it.name} (${it.type}) - ${it.desc||''}`).join('\n') : 'ì•„ì´í…œ ì—†ìŒ' }
    function renderPf(){ document.getElementById('pfBody').textContent=S.portfolio.length? S.portfolio.map(p=>`- ${p.title} [${p.grade}]\n${p.summary}`).join('\n\n'):'ì•„ì§ ê¸°ë¡ ì—†ìŒ' }

    // ====== í€˜ìŠ¤íŠ¸ ======
    function makeQuests(n){
      const cats=[
        {key:'ê°ë„', stat:'ê°ê°', type:'ì°½ì‘í˜•'},
        {key:'ì–¸ì–´', stat:'ê¸°íšë ¥', type:'ì°½ì‘í˜•'},
        {key:'ë¸Œëœë”©', stat:'ë¶„ì„ë ¥', type:'ì°½ì‘í˜•'},
        {key:'ë¦¬ë””ìì¸', stat:'ì •ë¦¬ë ¥', type:'ì°½ì‘í˜•'},
        {key:'ì „ëµ', stat:'ì‚¬ê³ ìœ ì—°ì„±', type:'ì„ íƒí˜•'},
        {key:'ë¦¬ì„œì¹˜', stat:'ìì•„ê°ì§€ë ¥', type:'ì„ íƒí˜•'},
        {key:'ê´‘ê³ ìš©ì–´', stat:'ì§‘ì¤‘ë ¥', type:'í€´ì¦ˆí˜•'},
        {key:'ì»¤ë®¤ë‹ˆì¼€ì´ì…˜', stat:'ì†Œí†µëŠ¥ë ¥', type:'ì°½ì‘í˜•'},
        {key:'ì²´ë ¥ë£¨í‹´', stat:'ì²´ë ¥', type:'ì„ íƒí˜•'},
        {key:'ë‚´ë¹„ê²Œì´ì…˜', stat:'ë°©í–¥ê°ê°', type:'í€´ì¦ˆí˜•'},
      ];
      const arr=[]; for(let i=1;i<=n;i++){ const c=cats[(i-1)%cats.length];
        const q={id:'Q'+String(i).padStart(3,'0'), idx:i, title:`${c.key} í€˜ìŠ¤íŠ¸ ${i}`, cat:c.key, stat:c.stat, type:c.type, unlocked:i<=6, done:false, grade:null};
        if(c.type==='í€´ì¦ˆí˜•'){ q.quiz={question:`${c.key} ê¸°ë³¸ ê°œë…ì„ ê³ ë¥´ì„¸ìš”.`, options:['A','B','C','D'], answer:'B'}; q.description='[í€´ì¦ˆ] ë³´ê¸° ì¤‘ ì •ë‹µ ì„ íƒ'; q.example='ì •ë‹µ: A/B/C/D ì¤‘ í•˜ë‚˜'; }
        else if(c.type==='ì„ íƒí˜•'){ q.choices=['ì „ëµ A','ì „ëµ B','ì „ëµ C']; q.description='[ì„ íƒ] ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ìµœì  ì „ëµì„ ì„ íƒ'; q.example='ë²„íŠ¼ ì¤‘ 1ê°œ ì„ íƒ'; }
        else { q.description='[ì°½ì‘] ì£¼ì œ ë¶„ì„/ì‚¬ë¡€/ì•„ì´ë””ì–´ë¥¼ 6~12ì¤„ ì‘ì„±'; q.example='ë¬¸ì œâ†’ì‚¬ë¡€ë¹„êµâ†’ì¸ì‚¬ì´íŠ¸â†’ì œì•ˆ'; }
        q.reward={exp:6+(i%5)*2, gold:30+(i%5)*15, item:(i%7===0?'ì§‘ì¤‘ì˜ ë¹„ì•½':null)};
        arr.push(q);
      } return arr;
    }

    let currentQ=null;
    function renderQuests(){
      const box=document.getElementById('questList');
      const open=S.quests.filter(q=>q.unlocked&&!q.done).slice(0,15);
      box.innerHTML = open.map(q=>`â€¢ <b>${q.id}</b> ${q.title} <small class="muted">(${q.type}/${q.stat})</small> <button class="btn secondary" data-open="${q.id}" style="margin-top:6px">ì—´ê¸°</button>`).join('\n');
      box.querySelectorAll('[data-open]').forEach(b=>b.onclick=()=>openQuest(b.dataset.open));
      document.getElementById('questDetail').classList.add('hidden');
    }
    function openQuest(id){
      const q=S.quests.find(x=>x.id===id); if(!q) return;
      currentQ=q;
      const meta=[
        `[#${q.idx}] ${q.title} <${q.type}>`,
        `ëŒ€ìƒ ìŠ¤íƒ¯: ${q.stat}`,
        `ì„¤ëª…: ${q.description}`,
        `ì˜ˆì‹œ: ${q.example}`
      ];
      if(q.type==='í€´ì¦ˆí˜•'){ meta.push(`ë¬¸í•­: ${q.quiz.question}`, 'ì„ íƒì§€: A / B / C / D'); }
      if(q.type==='ì„ íƒí˜•'){ meta.push('ì„ íƒì§€: '+q.choices.join(', ')); }
      document.getElementById('qMeta').textContent=meta.join('\n');
      document.getElementById('qAnswer').value='';
      document.getElementById('qResult').textContent='';
      document.getElementById('questDetail').classList.remove('hidden');
    }

    // ====== í‰ê°€(ëª¨ì˜/GPT) ======
    document.getElementById('btnMock').onclick=()=>doFinalize(mockEval());
    document.getElementById('btnEval').onclick=async ()=>{
      const key=localStorage.getItem(AKEY)||'';
      if(!key){ document.getElementById('qResult').textContent='API í‚¤ê°€ ì—†ì–´ ëª¨ì˜í‰ê°€ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.'; return doFinalize(mockEval()); }
      const ans=document.getElementById('qAnswer').value.trim(); if(!ans) return alert('ì œì¶œë¬¼ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤');
      document.getElementById('qResult').textContent='í‰ê°€ ì¤‘...';
      try{
        const out=await gptEval(currentQ, ans, key);
        document.getElementById('qResult').textContent=out.text;
        doFinalize(out);
      }catch(e){ document.getElementById('qResult').textContent='ì˜¤ë¥˜: '+e.message; }
    };

    function mockEval(){
      const grades=['S','A','B','C','D']; const g=grades[Math.floor(Math.random()*grades.length)];
      return {grade:g, text:`ëª¨ì˜í‰ê°€ ê²°ê³¼: ${g}\nê°•ì 2/ê°œì„ 2/ë‹¤ìŒê³¼ì—… ì œì•ˆ`, summary:`ëª¨ì˜í”¼ë“œë°±(${g})`};
    }
    async function gptEval(q, ans, key){
      const res = await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
        body: JSON.stringify({
          model:'gpt-4o',
          messages:[
            {role:'system',content:'ë„ˆëŠ” ë§ˆì¼€íŒ… RPGì˜ í€˜ìŠ¤íŠ¸ í‰ê°€ìë‹¤. ì œì¶œë¬¼ì— ëŒ€í•´ 1) í•œì¤„ ì´í‰ 2) ê°•ì  2ê°œ 3) ê°œì„  2ê°œ 4) ìµœì¢… ë“±ê¸‰(S/A/B/C/D/F í•œ ê¸€ì) 5) ë‹¤ìŒ ê³¼ì—…ì„ ê°„ê²°íˆ ì¶œë ¥.'},
            {role:'user',content:`[í€˜ìŠ¤íŠ¸] ${q.title} / ìœ í˜•:${q.type} / ìŠ¤íƒ¯:${q.stat}\n[ì„¤ëª…] ${q.description}\n[ì œì¶œë¬¼]\n${ans}`}
          ], temperature:0.7
        })
      });
      if(!res.ok){ const t=await res.text(); throw new Error(`API ${res.status}: ${t}`); }
      const data=await res.json(); const text=data.choices?.[0]?.message?.content||'(ì‘ë‹µ ì—†ìŒ)';
      const g=(text.match(/\b([SABCDFr])\b/i)||[])[1]?.toUpperCase()||'B';
      return {grade:g, text, summary:text};
    }

    function doFinalize({grade, text, summary}){
      if(!currentQ) return;
      const q=currentQ; q.done=true; q.grade=grade;
      const mult={S:1.8,A:1.4,B:1.0,C:0.7,D:0.4,F:0.2}[grade]||1.0;
      const exp=Math.round(q.reward.exp*mult), gold=Math.round(q.reward.gold*mult);
      S.exp+=exp; S.gold+=gold;
      if(grade==='S') S.stats[q.stat]=(S.stats[q.stat]||0)+2; else if(grade==='A') S.stats[q.stat]=(S.stats[q.stat]||0)+1;
      if(q.reward.item) S.inv.push({name:q.reward.item,type:'ì†Œë¹„',desc:`ì‚¬ìš© ì‹œ ${q.stat}+1`});
      S.portfolio.unshift({title:q.title, grade, summary});
      levelUp(); unlockMore(); save();
      document.getElementById('qResult').textContent += `\n\nâ€” ê²°ê³¼ â€”\në“±ê¸‰:${grade}  EXP+${exp}  GOLD+${gold}`;
      renderTop();
    }

    function levelUp(){ let need=needExp(), up=false; while(S.exp>=need){S.exp-=need; S.level++; need=needExp(); up=true;}
      if(up){ const keys=Object.keys(S.stats); for(let i=0;i<3;i++){const k=keys[(S.level+i)%keys.length]; S.stats[k]++;} }
    }
    function unlockMore(){ const open=S.quests.filter(q=>q.unlocked&&!q.done).length; const toOpen=Math.max(0,10-open);
      for(const q of S.quests){ if(!q.unlocked&&toOpen>0){ q.unlocked=true; } }
    }

    // ====== ì €ì¥ ======
    function save(){ localStorage.setItem(SKEY, JSON.stringify(S)); }
    document.getElementById('btnSaveKey').onclick=()=>{ localStorage.setItem(AKEY, document.getElementById('apiKey').value.trim()); alert('API í‚¤ ì €ì¥ë¨'); };
    document.getElementById('btnExport').onclick=()=>{ const blob=new Blob([JSON.stringify(S)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='JH_RPG_SAVE.json'; a.click(); };
    document.getElementById('btnImport').onclick=()=>{ const i=document.createElement('input'); i.type='file'; i.accept='.json,application/json'; i.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ S=JSON.parse(r.result); save(); show('status'); }catch{ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); } }; r.readAsText(f); }; i.click(); };

    // ====== ì‹œì‘ ë° SW ë“±ë¡ ======
    document.getElementById('btnStart').onclick=()=>{ show('quests'); save(); };
    if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js')); }
    renderTop(); // ì²« ë Œë”
  </script>
</body>
</html>